name: Quality Gates - Agent Validation Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  yaml-syntax-validation:
    name: YAML Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml pytest

      - name: Validate YAML syntax
        run: |
          python -c "
          import yaml
          import sys
          from pathlib import Path

          errors = []
          personas_dir = Path('data/personas')

          if personas_dir.exists():
              for yaml_file in personas_dir.glob('*.yaml'):
                  try:
                      with open(yaml_file, 'r') as f:
                          yaml.safe_load(f)
                      print(f'‚úÖ {yaml_file.name}')
                  except yaml.YAMLError as e:
                      errors.append(f'{yaml_file.name}: {e}')
                      print(f'‚ùå {yaml_file.name}: {e}')

          if errors:
              print(f'\nYAML Validation Failed: {len(errors)} errors')
              sys.exit(1)
          else:
              print(f'\nYAML Validation Passed: All files valid')
          "

  structure-validation:
    name: Agent Structure Validation
    runs-on: ubuntu-latest
    needs: yaml-syntax-validation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run structure validation
        run: |
          python -m pytest tests/test_enhanced_validation.py::test_all_agents_content_validation -v

      - name: Run trait validation
        run: |
          python -m pytest tests/test_enhanced_validation.py::test_all_traits_content_validation -v

  generation-validation:
    name: Agent Generation Validation
    runs-on: ubuntu-latest
    needs: structure-validation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Test agent generation
        run: |
          python -m pytest tests/test_content_pipelines.py::test_generation_pipeline -v

      - name: Validate output quality
        run: |
          python -m pytest tests/test_content_pipelines.py::test_minimum_content_requirements -v

  integration-testing:
    name: Cross-Agent Integration Testing
    runs-on: ubuntu-latest
    needs: generation-validation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run cross-agent consistency tests
        run: |
          python -m pytest tests/test_enhanced_validation.py::test_cross_agent_consistency -v

      - name: Run trait import validation
        run: |
          python -m pytest tests/test_enhanced_validation.py::test_trait_import_validation -v

      - name: Run comprehensive integration tests
        run: |
          python -m pytest tests/test_integration.py -v

  comprehensive-validation:
    name: Comprehensive Quality Gates
    runs-on: ubuntu-latest
    needs: [yaml-syntax-validation, structure-validation, generation-validation, integration-testing]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run complete validation pipeline
        run: |
          python -m pytest tests/test_content_pipelines.py::test_quality_gates_pipeline -v

      - name: Generate validation summary
        run: |
          python -m pytest tests/test_content_pipelines.py::test_comprehensive_validation_summary -v

      - name: Archive validation reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: validation-reports
          path: |
            test-results/
            validation-reports/
          retention-days: 30

  security-validation:
    name: Security and Compliance Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security scan
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_YAML: true
          VALIDATE_PYTHON: true
          VALIDATE_MARKDOWN: true

      - name: Check for sensitive data
        run: |
          # Check for potential secrets or sensitive data in YAML files
          if grep -r -i -E "(password|secret|key|token|api_key)" data/personas/ --include="*.yaml"; then
            echo "‚ö†Ô∏è Potential sensitive data found in agent configurations"
            exit 1
          else
            echo "‚úÖ No sensitive data detected in agent configurations"
          fi

  performance-validation:
    name: Performance and Scale Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install memory-profiler

      - name: Performance benchmarking
        run: |
          python -c "
          import time
          import psutil
          import os
          from claude_config.composer import AgentComposer
          from pathlib import Path

          print('üöÄ Performance Benchmarking')

          # Memory usage before
          process = psutil.Process(os.getpid())
          mem_before = process.memory_info().rss / 1024 / 1024  # MB

          # Time agent generation
          start_time = time.time()
          composer = AgentComposer()

          # Generate a few test agents
          test_agents = ['ai-engineer', 'python-engineer', 'frontend-engineer']
          for agent in test_agents:
              try:
                  composer.load_agent(agent)
                  print(f'‚úÖ Loaded {agent}')
              except Exception as e:
                  print(f'‚ùå Failed to load {agent}: {e}')

          end_time = time.time()

          # Memory usage after
          mem_after = process.memory_info().rss / 1024 / 1024  # MB

          generation_time = end_time - start_time
          memory_usage = mem_after - mem_before

          print(f'üìä Performance Results:')
          print(f'   Generation Time: {generation_time:.2f}s')
          print(f'   Memory Usage: {memory_usage:.2f} MB')
          print(f'   Agents per second: {len(test_agents)/generation_time:.2f}')

          # Performance thresholds
          if generation_time > 10:
              print('‚ö†Ô∏è Generation time exceeds threshold (10s)')
              exit(1)

          if memory_usage > 100:
              print('‚ö†Ô∏è Memory usage exceeds threshold (100MB)')
              exit(1)

          print('‚úÖ Performance validation passed')
          "

  deployment-readiness:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [comprehensive-validation, security-validation, performance-validation]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Final deployment check
        run: |
          echo "üéØ Final Deployment Readiness Check"

          # Count agents and traits
          AGENT_COUNT=$(find data/personas -name "*.yaml" | wc -l)
          TRAIT_COUNT=$(find src/claude_config/traits -name "*.md" | wc -l)

          echo "üìä System Metrics:"
          echo "   Agents: $AGENT_COUNT"
          echo "   Traits: $TRAIT_COUNT"

          # Minimum deployment requirements
          if [ "$AGENT_COUNT" -lt 25 ]; then
            echo "‚ùå Insufficient agents for deployment ($AGENT_COUNT < 25)"
            exit 1
          fi

          if [ "$TRAIT_COUNT" -lt 10 ]; then
            echo "‚ùå Insufficient traits for deployment ($TRAIT_COUNT < 10)"
            exit 1
          fi

          echo "‚úÖ Deployment readiness check passed"
          echo "üöÄ System ready for deployment"

      - name: Create deployment artifact
        run: |
          # Build all agents for deployment
          python -c "
          from claude_config.composer import AgentComposer
          from pathlib import Path
          import tempfile
          import shutil

          print('üîß Building deployment artifacts...')

          with tempfile.TemporaryDirectory() as temp_dir:
              output_dir = Path(temp_dir) / 'deployment'
              output_dir.mkdir()

              composer = AgentComposer(output_dir=output_dir)
              built_agents = composer.build_all_agents()

              print(f'‚úÖ Built {len(built_agents)} agents for deployment')

              # Copy to artifacts directory
              artifacts_dir = Path('deployment-artifacts')
              if artifacts_dir.exists():
                  shutil.rmtree(artifacts_dir)
              shutil.copytree(output_dir, artifacts_dir)

          print('üì¶ Deployment artifacts created')
          "

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deployment-ready-agents
          path: deployment-artifacts/
          retention-days: 90